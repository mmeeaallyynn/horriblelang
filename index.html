<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
</head>
<body>

<textarea rows="40" cols="80" id="text" style="background: #FFF; color: #000; font-size: 1.5em">
fibonacci is
  counter is _ in

  a is 0 in
  b is 1 in
  result is 0 in

  loop {
    (a + b) -> @result

    @b! -> @a
    @result! -> @b

    @counter @std::dec!

    (counter > 0) then {
      @loop!
    } @std::if!
  } @loop!

  @result!
in


"a number:" @std::prompt! -> @fibonacci::counter
"result: " @fibonacci! + @std::alert!

add is + in
0 -> @std::fold::accu
1 10 @std::range! @add @std::fold!

</textarea>
<br>
REPL<input type="text" id="repl"></input>
<br>
<button id="ok">OK</button>

<div id="result"></div>

<script type="text/notherlang">
std {
  if is
    @then jump?
  in
  endl is
    "\n" print
  in
  println is
    print
  in
  dec is
    ref is 0 in @ref put
    @ref! jump 1 - @ref! put
  in
  inc is
    ref is 0 in @ref put
    @ref! jump 1 + @ref! put
  in
  alert is
    "alert(\"" swap "\")" + + __jseval drop
  in
  prompt is 
    "prompt(\"" swap "\")" + + __jseval
  in
  fold is 
    guard is "|" in
    func is _ in
    accu is _ in

    -> @func

    loop_start {
      dup @guard! != then {
        @accu! @func! jump -> @accu
        @loop_start!
      } @std::if!
    } @loop_start!

    drop
    @accu!
  in
  range is 
    from is _ in
    to   is _ in
    step is 1 in
    -> @to
    -> @from

    |
    loop_start {
      (from < to) then {
        (to - step) -> @to
        @to!
        @loop_start!
      } @std::if!
    } @loop_start!
  in
  foreach is
    guard is "|" in
    func is _ in

    -> @func

    loop_start {
      dup @guard! != then {
        @func! jump
        @loop_start!
      } @std::if!
    } @loop_start!

    drop
  in
}
""
</script>


<script type="text/javascript" src="pkg/notherlang.js"></script>
<script type="module">
const { produce, run_string } = wasm_bindgen;
async function run() {
	let prog = "";

	for(let tag of document.getElementsByTagName("script")) {
		if(tag.type == "text/notherlang") {
			prog += tag.innerHTML;
		}
	}

	await wasm_bindgen("./pkg/notherlang_bg.wasm");

  document.getElementById("repl").onkeydown = (event) => {
    if (event.key == "Enter") {
      document.getElementById("result").innerHTML = run_string(
        document.getElementById("repl").value
      );
      document.getElementById("repl").value = "";
    }
  };

  document.getElementById("result").innerHTML = run_string(prog);
	document.getElementById("ok").onclick = () => {
	  document.getElementById("result").innerHTML = run_string(
	    document.getElementById("text").value
    );
	}
}
run();
</script>
</body>
</html>
