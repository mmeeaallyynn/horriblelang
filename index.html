<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
<style>
* {
  color: #BBB !important;
  background-color: #333 !important;;
}
</style>
</head>
<body>
<div id=stuff style="position: relative; overflow: hidden; resize: both">
<div id="lines" rows="40" cols="2" style="padding-top: 3px; background: #FFF; color: #000; font-size: 12pt; position: relative; float: left; overflow: hidden">
</div>
<textarea rows="2000" cols="80" id="text" style="background: #FFF; color: #000; font-size: 12pt; position: relative; float: left">
fibonacci is
  counter is _ in

  a is 0 in
  b is 1 in
  result is 0 in

  loop {
    (@a! + @b!) -> @result

    @b! -> @a
    @result! -> @b

    @counter @std::dec!

    (@counter! > 0) then {
      @loop!
    } @std::if!
  } @loop!

  @result!
in


"a number:" @std::prompt! -> @fibonacci::counter
"result: " @fibonacci! + @std::alert!

1 10 @std::range! @std::op::+ 0 @std::fold!
</textarea>
<div id="stackinfo" style="position: relative; float: left">
</div>
</div>
<button id="ok">OK</button>

<div id="result"></div>

<script type="text/notherlang">
STACK_START

memory {
  mem is _100 in
  idx is 0 in

  alloc is
    @memory::mem @memory::idx! +
    swap
    @memory::idx! + -> @memory::idx
  in
}

std {
  op {
    "+" is + in
    "-" is - in
    "*" is * in
    "/" is / in
    "drop" is drop in
  }
  if is
    @then jump?
  in
  endl is
    "\n" print
  in
  println is
    print
  in
  dec is
    ref is 0 in @ref put
    @ref! jump 1 - @ref! put
  in
  inc is
    ref is 0 in @ref put
    @ref! jump 1 + @ref! put
  in
  alert is
    "alert(\"" swap "\")" + + __jseval drop
  in
  prompt is 
    "prompt(\"" swap "\")" + + __jseval
  in
  fold is 
    guard is "|" in
    func is _ in
    accu is _ in

    -> @accu
    -> @func

    loop_start {
      dup @guard! != then {
        @accu! @func! jump -> @accu
        @loop_start!
      } @std::if!
    } @loop_start!

    drop
    @accu!
  in
  range is 
    from is _ in
    to   is _ in
    step is 1 in
    -> @to
    -> @from

    |
    loop_start {
      (@from! < @to!) then {
        (@to! - @step!) -> @to
        @to!
        @loop_start!
      } @std::if!
    } @loop_start!
  in
  foreach is
    guard is "|" in
    func is _ in

    -> @func

    loop_start {
      dup @guard! != then {
        @func! jump
        @loop_start!
      } @std::if!
    } @loop_start!

    drop
  in
  join is 
    guard is "|" in
    sep is _ in
    accu is "" in

    -> @sep
    -> @accu

    loop_start {
      dup @guard! != then {
        @sep! @accu! + + -> @accu
        @loop_start!
      } @std::if!
    } @loop_start!

    drop
    @accu!
  in
  droplist is
    lambda drop in @std::foreach!
  in
  dropall is
    STACK_START -> @std::foreach::guard
    lambda drop in @std::foreach!
    "|" -> @std::foreach::guard
    STACK_START
  in
  string is 
    \space @std::join!
  in
  pow is
    base is _ in
    exp  is _ in
    val  is 1 in
    op   is _ in

    1 -> @val
    @std::op::* -> @op

    -> @exp
    -> @base

    (@exp! < 0) lambda
      @std::op::/ -> @op
      (@exp! * -1) -> @exp
    in jump?

    0 @exp! @std::range! 
    lambda
      drop
      @val! @base! @op! jump -> @val
    in @std::foreach!

    @val!
  in
}
</script>


<script type="text/javascript" src="pkg/notherlang.js"></script>
<script type="module">
const { produce, run_string } = wasm_bindgen;
async function run() {
    let prog = "";

    for(let tag of document.getElementsByTagName("script")) {
	    if(tag.type == "text/notherlang") {
		    prog += tag.innerHTML;
	    }
    }

    await wasm_bindgen("./pkg/notherlang_bg.wasm");

    let lines = document.getElementById("lines");
    let text = document.getElementById("text");
    let container = document.getElementById("stuff");

    text.onresize = (event) => {
        lines.style.height = text.clientHeight;
    }

    let range = Array.from(new Array(2000), (x, i) => i).join("<br>")
    lines.innerHTML = range;

    document.getElementById("text").onkeydown = (event) => {
        // shift+enter to execute contents
        if (event.key == "Enter" && event.shiftKey == true) {
            event.preventDefault();
            document.getElementById("stackinfo").innerHTML = run_string(
                document.getElementById("text").value
            );
        }
        // expected behaviour for tab and shift+tab
        else if (event.key == "Tab") {
            let lines = text.value.split("\n");

            let selectionStart = text.selectionStart;
            let selectionEnd = text.selectionEnd;

            let lineNumberStart = text.value.slice(0, selectionStart).split("\n").length
            let lineNumberEnd = text.value.slice(0, selectionEnd).split("\n").length

            let multipleLinesSelected = (lineNumberStart != lineNumberEnd);
            let beginningOfLine = ["\n", undefined].includes(text.value[selectionStart - 1]);

            if (!multipleLinesSelected) {
                console.log("single line");
                if (event.shiftKey) {
                    if (lines[lineNumberStart - 1].startsWith("\t")) {
                        lines[lineNumberStart - 1] = lines[lineNumberStart - 1].slice(1);
                        console.log("beginning of line: ", beginningOfLine, selectionStart);
                        text.value = lines.join("\n");
                        text.selectionStart -=(beginningOfLine ? 0: 1);
                        text.selectionEnd -= (beginningOfLine ? 0: 1);
                    }
                }
                else {
                    text.value = text.value.slice(0, selectionStart) + "\t" + text.value.slice(selectionEnd);
                    text.selectionStart = selectionStart + 1;
                    text.selectionEnd = selectionEnd + 1;
                }
            }
            else {
                console.log("multiple lines");
                for (let lineNumber = lineNumberStart; lineNumber < lineNumberEnd; lineNumber++) {
                    if (event.shiftKey) {
                        if (lines[lineNumber - 1].startsWith("\t")) {
                            lines[lineNumber - 1] = lines[lineNumber - 1].slice(1);
                            text.selectionStart = selectionStart - (beginningOfLine ? 0: 1);
                            text.selectionEnd = selectionEnd - (beginningOfLine ? 0: 1);
                       }
                    }
                    else {
                        lines[lineNumber - 1] = "\t" + lines[lineNumber - 1];
                    }
                }
                text.value = lines.join("\n");
            }
            event.preventDefault();
        }
    };

    document.getElementById("result").innerHTML = run_string(prog);

    document.getElementById("ok").onclick = () => {
        document.getElementById("result").innerHTML = run_string(
            document.getElementById("text").value
        );
    }
}
run();
</script>
</body>
</html>
